{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">{{ template_data.title }}</h1>
            <p class="text-center text-muted mb-4">
                Discover what movies are trending in different regions. 
                Click on a region to see the most popular movies in that area.
            </p>
        </div>
    </div>
    
    <div class="row">
        <!-- Map Container -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Interactive Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 500px; width: 100%;"></div>
                </div>
            </div>
        </div>
        
        <!-- Movie List Container -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="region-title">Select a Region</h5>
                </div>
                <div class="card-body">
                    <div id="movie-list">
                        <p class="text-muted text-center">
                            Click on a region marker on the map to see trending movies in that area.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps JavaScript API -->
<!-- NOTE: Replace YOUR_API_KEY with your actual Google Maps API key -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE_xHy8Au5UfZ_sflVyI90rDTg-9jFy1k&callback=initMap"></script>

<script>
let map;
let markers = {};

// Initialize Google Map
function initMap() {
    // Initialize the map centered on a default location (e.g., center of US)
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: { lat: 39.8283, lng: -98.5795 },
        mapTypeId: 'roadmap',
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ]
    });
    
    // Region data from Django
    const regions = JSON.parse('{{ template_data.regions|escapejs }}');
    
    // Add markers for each region
    const bounds = new google.maps.LatLngBounds();
    regions.forEach(region => {
        const marker = new google.maps.Marker({
            position: { lat: region.lat, lng: region.lng },
            map: map,
            title: region.name,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="12" fill="#007bff" stroke="#ffffff" stroke-width="2"/>
                        <text x="16" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">ðŸŽ¬</text>
                    </svg>
                `),
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        // Add click event listener
        marker.addListener('click', function() {
            loadRegionMovies(region.id, region.name);
        });
        
        // Add info window for hover
        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div class="p-2">
                    <h6 class="mb-1">${region.name}</h6>
                    <p class="mb-0 text-muted small">Loading top movie...</p>
                </div>
            `
        });
        
        marker.addListener('mouseover', function() {
            // Show loading state first
            infoWindow.setContent(`
                <div class="p-2">
                    <h6 class="mb-1">${region.name}</h6>
                    <p class="mb-0 text-muted small">Loading top movie...</p>
                </div>
            `);
            infoWindow.open(map, marker);
            
            // Fetch top movie for this region
            fetch(`/movies/api/region/${region.id}/movies/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.trending_movies || data.trending_movies.length === 0) {
                        infoWindow.setContent(`
                            <div class="p-2">
                                <h6 class="mb-1">${region.name}</h6>
                                <p class="mb-0 text-muted small">No movie data available</p>
                            </div>
                        `);
                    } else {
                        const topMovie = data.trending_movies[0];
                        infoWindow.setContent(`
                            <div class="p-2">
                                <h6 class="mb-1">${region.name}</h6>
                                <div class="d-flex align-items-center mt-2">
                                    <img src="${topMovie.image}" alt="${topMovie.name}" 
                                         style="width: 40px; height: 60px; object-fit: cover; margin-right: 8px;">
                                    <div>
                                        <p class="mb-1 fw-bold small">${topMovie.name}</p>
                                        <p class="mb-0 text-success small">
                                            <i class="fas fa-shopping-cart"></i> ${topMovie.total_quantity} sold
                                        </p>
                                    </div>
                                </div>
                                <p class="mb-0 text-muted small mt-1">Click for full list</p>
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    console.error('Error loading region movies:', error);
                    infoWindow.setContent(`
                        <div class="p-2">
                            <h6 class="mb-1">${region.name}</h6>
                            <p class="mb-0 text-muted small">Error loading data</p>
                        </div>
                    `);
                });
        });
        
        marker.addListener('mouseout', function() {
            infoWindow.close();
        });
        
        markers[region.id] = marker;
        bounds.extend(marker.getPosition());
    });
    
    // Fit map to show all markers
    if (regions.length > 0) {
        map.fitBounds(bounds);
    }
}

// Function to load movies for a specific region
function loadRegionMovies(regionId, regionName) {
    // Update the region title
    document.getElementById('region-title').textContent = `Trending in ${regionName}`;
    
    // Show loading state
    document.getElementById('movie-list').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading trending movies...</p>
        </div>
    `;
    
    // Fetch movie data from API
    fetch(`/movies/api/region/${regionId}/movies/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('movie-list').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        ${data.error}
                    </div>
                `;
                return;
            }
            
            // Display the movies
            if (data.trending_movies.length === 0) {
                document.getElementById('movie-list').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        No movie data available for this region yet.
                    </div>
                `;
                return;
            }
            
            let moviesHtml = '<div class="list-group">';
            data.trending_movies.forEach((movie, index) => {
                moviesHtml += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="d-flex">
                                <img src="${movie.image}" alt="${movie.name}" 
                                     class="me-3" style="width: 50px; height: 75px; object-fit: cover;">
                                <div>
                                    <h6 class="mb-1">${movie.name}</h6>
                                    <p class="mb-1 text-muted small">$${movie.price}</p>
                                    <small class="text-success">
                                        <i class="fas fa-shopping-cart"></i> 
                                        ${movie.total_quantity} sold
                                    </small>
                                </div>
                            </div>
                            <span class="badge bg-primary rounded-pill">#${index + 1}</span>
                        </div>
                    </div>
                `;
            });
            moviesHtml += '</div>';
            
            document.getElementById('movie-list').innerHTML = moviesHtml;
        })
        .catch(error => {
            console.error('Error loading region movies:', error);
            document.getElementById('movie-list').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Error loading movie data. Please try again.
                </div>
            `;
        });
}
</script>

<style>
#map {
    border-radius: 0.375rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #dee2e6;
}

.list-group-item:last-child {
    border-bottom: none;
}

.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}
